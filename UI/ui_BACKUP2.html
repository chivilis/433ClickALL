<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
      <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
      <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js'></script>
      
    <title></title>
  </head>
  <body>
    <canvas id="myChart" width="400" height="400"></canvas>
  </body>
    
</html>

<script>
    
    //var MIDIFile = require('midifile')
    var parseMidi = require('midi-file').parseMidi
    var fs = require('fs')
    var load = require('audio-loader');
    Analyser = require('audio-analyser')
    var Chart = require('chart');
    /*
    var MidiTrack = function(buffer){
        filteredMidi = {
            trackName: [],
            notes: []
        };        
        
        buffer.tracks[buffer.tracks.length-1].map(function(ev) {
        try {
            if(ev.type === 'trackName') {
                filteredMidi.trackName.push(ev.text)
            } else if(ev.type === 'noteOn') {
                filteredMidi.notes.push(
                    {
                        'note': ev.noteNumber,
                        'velocity': ev.velocity,
                        'deltaTime': ev.deltaTime
                        // FIXME -> MAKING MIDI INFO TRACKS
                    }
                );
            }
        }
        catch(err) {
            console.log('no property type')
        }
    })
        
        return filteredMidi;
    }
    
    
    // load midi buffer
    //lunch midiAnalyseR
    var input = fs.readFileSync('./assets/test1.mid');
    var parsedMidi = parseMidi(input);
    
    var filteredMidi = new MidiTrack(parsedMidi)
    console.log(filteredMidi)
    
    
    console.log(parsedMidi)
        
    // filter note events    
    var targetTrack = parsedMidi.tracks.length -1;
    //console.log(targetTrack)
   
    var trackName = null;
    
    parsedMidi.tracks[targetTrack].map(function(ev) {
        try {
            if(ev.type === 'trackName') trackName = ev.text
            else if(ev.type === 'noteOn') console.log(ev.noteNumber)
            
        }
        catch(err) {
            console.log('no property type')
        }
    })
    console.log(trackName)
    */
    
    
    
    /*
    var osc = require('node-osc');
    
    var client = new osc.Client('192.168.8.100', 3334);
        client.send('f/tempo/raw', 11, function () {
            client.kill();
        });
    
    var oscServer = new osc.Server(3333, '127.0.0.1');
    oscServer.on("message", function (msg, rinfo) {
        //if(msg[2][0] == '/tempo') {
            console.log(msg[2][0]);      
        //}
      
    });
    */
    
    
    
    
    var analyser = new Analyser({
    // Magnitude diapasone, in dB 
    minDecibels: -100,
    maxDecibels: -30,
 
    // Number of time samples to transform to frequency 
    fftSize: 1024,
 
    // Number of frequencies, twice less than fftSize 
    frequencyBinCount: 1024,
 
    // Smoothing, or the priority of the old data over the new data 
    smoothingTimeConstant: 0.2,
 
    // Number of channel to analyse 
    channel: 0,
 
    // Size of time data to buffer 
    bufferSize: 44100,
 
    // Windowing function for fft, https://github.com/scijs/window-functions 
    applyWindow: function (sampleNumber, totalSamples) {
    }
 
    //...pcm-stream params, if required 
    });
    
    
    load('./assets/click.wav').then(function (buffer) {
        //console.log(analyser.getByteFrequencyData(buffer)) 
        //console.log(load.loadArrayData)
        //console.log(analyser().getFrequencyData(buffer))
        //play(buffer)
        
        
    })
    
    fs.readFile('./assets/clickOneClick.wav', function(err, audioFile) {
        console.log(audioFile.length);
        //console.log(audioFile);
        //console.log(AudioContext);
        
        /*
        var audioContext = new AudioContext();
        audioContext.decodeAudioData(audioFile).then(function(decodedData) {
            // use the decoded data here
            console.log(audioFile);
        });
        */
        
        //var audioFile = analyser.getFloatTimeDomainData(audioFile)
        
        //var possArray = new Array();
        /*
        audioFile.forEach(function(data) {
            
            var prevData = data;
            // catch highest sample
            
            
                possArray.push(data);
                //console.log(data + ' --- ' )// data.indexOf())
            }
        )
        */
        //onsole.log(audioFile.length)
       /*
        for(var i = 0; audioFile.length > i; i++) {
            possArray.push(audioFile[i])
            //var maxSampleGainInTrack = audioFile[i]
            
            if(audioFile[i] < audioFile[i+1] ) {
                
            }
            
            //console.log(audioFile[i])
            count = i;
        }
        //console.log(audioFile[11445])
        */
        $(document).ready(function(doc) {
            console.log($(window).height())
            var ctx = document.getElementById("myChart").getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
                    datasets: [{
                        label: '# of Votes',
                        data: [10, 2, 5, 14, 3],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero:true
                            }
                        }]
                    }
                }
            });
        });
    
    });
    
</script>