<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
      <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
      <script src='../lib/p5/p5.min.js'></script>
      <script src='../lib/p5/p5.sound.min.js'></script>
      <script src="../lib/wavesurfer.js"></script>
     <!--
      <script src='https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.5.10/addons/p5.sound.min.js
                   '></script>-->
      <!--
      <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/0.2.0/Chart.min.js" type="text/javascript"'></script>
      -->
    <title></title>
  </head>
  <body>
    <!--<canvas id="myChart" width="400" height="400"></canvas>-->
      <div id="waveform"></div>
      <div id="waveform2"></div>
      <div id="container" style='display-inline'>
      <div id='test_blinker' style= 'position:relative; height:100px;width:100px;' ></div>
      <div id='test_blinker2' style= 'position:relative; height:100px;width:100px;' ></div>
      </div>
  </body>
    
</html>

<script>
    let fs = require('fs');
    let util = require('audio-buffer-utils');
    //LUNCH MIDI MODULES
    require('./midi.js');
    let smt = require('node-smt')

    //LUNCH OSC MODULES
    //require('./osc.js');
    
    /*
    var wavesurfer = WaveSurfer.create({
        container: '#waveform',
        waveColor: 'grey',
        progressColor: 'purple'
    });
    
    var wavesurfer2 = WaveSurfer.create({
        container: '#waveform2',
        waveColor: 'grey',
        progressColor: 'purple'
    });
    
    wavesurfer.load('../assets/click.wav');
    wavesurfer2.load('../assets/test.wav');
    */
    
    var tempoTrack = fs.readFileSync('./assets/tempoTrackCB.smt');
    //console.log(smt(tempoTrack))
    
    
    xml2js = require('xml2js');
 
    var parser = new xml2js.Parser(
        {
            trim: true,
            normalize: true,
            mergeAttrs: true
        });
    fs.readFile('./assets/tempoTrackCB.smt', function(err, data) {
        parser.parseString(data, function (err, result) {
            console.dir(result);
            console.log('Done');
        });
    });
    
    
    
    var MidiPlayer = require('midi-player-js');

    // Initialize player and register event handler
    var Player = new MidiPlayer.Player();

    // Load a MIDI file
    Player.loadFile('./assets/test1.mid');
    Player.play();
    setInterval(function() {
        Player.getSongTimeRemaining()>0 ? console.log(Player.getSongTimeRemaining()) : console.log('not av')
    }, 1000)
    
    //console.log(Player.isPlaying())
    
    
    var song, analyzer;

    function preload() {
        song = loadSound('../assets/click.wav');
        song2 = loadSound('../assets/test.wav');
    }
     

    function setup() {
        createCanvas(710, 200);
        //song.play()
        //song2.play()
        
        // create a new Amplitude analyzer
        analyzer = new p5.Amplitude();
        
        // Patch the input to an volume analyzer
        analyzer.setInput(song);
        //console.log(analyzer)
        //console.log(getRandomIntInclusive(0, 255));
        //console.log(wavesurfer)
        
        
    }
    

    function draw() {
      background(255);
        //console.log(this)
      // Get the average (root mean square) amplitude
      var rms = analyzer.getLevel();
        _tempRms = 0;
        if(rms > 0.1) {
            _tempRms = rms;
        }
      fill(127);
      stroke(0);

      // Draw an ellipse with size based on volume
      ellipse(width/2, height/2, 10+_tempRms*200, 10+_tempRms*200);
    }
    
    
    
    

    
</script>