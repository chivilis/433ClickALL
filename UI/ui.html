<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
      
      <!--
        <script src="..\node_modules\osc\dist\osc-browser.min.js"></script>
      -->
      
      <!--
      <script src='..\node_modules\midifile\dist\MIDIFile.js'></script>
      -->
    <title></title>
  </head>
  <body>
 ___
  </body>
    
</html>

<script>
    
    //var MIDIFile = require('midifile')
    var parseMidi = require('midi-file').parseMidi
    var fs = require('fs')
    
    var MidiTrack = function(buffer){
        filteredMidi = {
            trackName: [],
            notes: []
        };        
        
        buffer.tracks[buffer.tracks.length-1].map(function(ev) {
        try {
            if(ev.type === 'trackName') {
                filteredMidi.trackName.push(ev.text)
            } else if(ev.type === 'noteOn') {
                filteredMidi.notes.push(
                    {
                        'note': ev.noteNumber,
                        'velocity': ev.velocity,
                        'deltaTime': ev.deltaTime
                        // FIXME -> MAKING MIDI INFO TRACKS
                    }
                );
            }
        }
        catch(err) {
            console.log('no property type')
        }
    })
        
        return filteredMidi;
    }
    
    
    // load midi buffer
    var input = fs.readFileSync('./assets/test1.mid');
    var parsedMidi = parseMidi(input);
    
    var filteredMidi = new MidiTrack(parsedMidi)
    console.log(filteredMidi)
    
    
    console.log(parsedMidi)
    
    /*
    console.log(parsedMidi);
    
    // filter note events    
    var targetTrack = parsedMidi.tracks.length -1;
    //console.log(targetTrack)
   
    var trackName = null;
    
    parsedMidi.tracks[targetTrack].map(function(ev) {
        try {
            if(ev.type === 'trackName') trackName = ev.text
            else if(ev.type === 'noteOn') console.log(ev.noteNumber)
            
        }
        catch(err) {
            console.log('no property type')
        }
    })
    console.log(trackName)
    */
    
    
    
// Creating the MIDIFile instance 
    //var midiFile = new MIDIFile(input);
   // console.log(midiFile)
 /*
// Reading headers 
midiFile.header.getFormat(); // 0, 1 or 2 
midiFile.header.getTracksCount(); // n 
// Time division 
if(midiFile.header.getTimeDivision() === MIDIFileHeader.TICKS_PER_BEAT) {
    midiFile.header.getTicksPerBit();
} else {
    midiFile.header.getSMPTEFrames();
    midiFile.header.getTicksPerFrame();
}
 
// MIDI events retriever 
var events = midiFile.getMidiEvents();
events[0].subtype; // type of [MIDI event](https://github.com/nfroidure/MIDIFile/blob/master/src/MIDIFile.js#L34) 
events[0].playTime; // time in ms at wich the event must be played 
events[0].param1; // first parameter 
events[0].param2; // second one 
 
// Lyrics retriever 
var lyrics = midiFile.getLyrics();
lyrics[0].playTime; // Time at wich the text must be displayed 
lyrics[0].text; // The text content to be displayed 
 
// Reading whole track events and filtering them yourself 
var trackEventsChunk = midiFile.getTrackEvents(0);
var	events = new MIDIFile.createParser(trackEventsChunk);
var event;
 
while(event=events.next()) {
    // Printing meta events containing text only 
    if(event.type === MIDIFile.EVENT_META && event.text) {
        console.log('Text meta: '+event.text);
    }
}
*/
    var osc = require('node-osc');
    
    var client = new osc.Client('192.168.8.100', 3334);
        client.send('f/tempo/raw', 11, function () {
            client.kill();
        });
    
    var oscServer = new osc.Server(3333, '127.0.0.1');
    oscServer.on("message", function (msg, rinfo) {
        //if(msg[2][0] == '/tempo') {
            console.log(msg[2][0]);      
        //}
      
    });
</script>